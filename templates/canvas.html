<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
    dir="{% if LANGUAGE_BIDI %}rtl{% else %}ltr{% endif %}"
    xml:lang="{% firstof LANGUAGE_CODE 'en' %}"
    lang="{% firstof LANGUAGE_CODE 'en' %}">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.3/jquery.min.js"></script>
        <script type="text/javascript" src="{{ MEDIA_URL }}js/jwplayer.js"></script>
    </head>
    <body>
        <body>
            <img id='avatar' src='http://graph.facebook.com/katsev/picture?type=square'/>
            <div id='jwp_container'>Loading the player ...</div>
        </body>
    </body>
    <script type="text/javascript" charset="utf-8">
        jQuery(function () {
            var pending_reload = false;

            function PlaylistHelper(player) {
                this.new_items = [];
                this.player = player;
                this.addPlaylistItem = function (new_item) {
                    return this.new_items.push(new_item);
                };
                this.addPlaylistItemFromPost = function (post) {
                    return this.addPlaylistItem({
                        file: post.vid_src,
                        image: post.img_src,
                        fb_post: post,              // monkey patch?!
                    });
                };
                this.reloadPlaylist = function () {
                    pending_reload = false;
                    if (this.new_items.length > 0) {
                        var newPlaylist = this.player.getPlaylist().concat(this.new_items);
                        this.player.load(newPlaylist);
                        this.new_items = [];
                        pending_reload = true;
                    };
                };
            }

            var player = jwplayer('jwp_container');
            var playlist_helper = new PlaylistHelper(player);

            function reloadPlaylist() {
                    console.log('actually loaded');
                    playlist_helper.reloadPlaylist();
            }

            function fetchVideoPosts(callback) {
                jQuery.getJSON('{% url facebook.views.videos_increment %}', function (posts) {
                    for (var i = posts.length - 1; i >= 0; i--) {
                        playlist_helper.addPlaylistItemFromPost(posts[i]);
                    };
                    if (callback) callback();
                });
            }

            function updatePage(post) {
                $('#avatar').attr('src', 'http://graph.facebook.com/' + post.fb_post.source_id + '/picture?type=square');
            }

            var initial_load = true;

            player.setup({
                flashplayer: '{{ MEDIA_URL }}swf/player.swf',
                height: 800,
                width: 700,
                skin: '{{ MEDIA_URL }}skins/smooth.zip',
                "playlist.position": "bottom",
                "playlist.size": 400,
            }).onReady(function () {
                fetchVideoPosts(reloadPlaylist);

            }).onComplete(function () {
                this.playlistNext();

            }).onPlaylistItem(function (data) {
                updatePage(this.getPlaylist()[data.index]);
                var playlist_len = this.getPlaylist().length;
                if (data.index > (playlist_len - 3)) {
                    fetchVideoPosts();
                };
                pending_reload = false;
                if (data.index == (playlist_len - 1)) {
                    reloadPlaylist();
                };

            }).onPlaylist(function (data) {
                this.play();

            }).onIdle(function (data) {
                if (pending_reload) this.play();
            });
        });
    </script>
</html>
